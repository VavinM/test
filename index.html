<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Детальная разбаловка по вопросам</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    body { font-family: Arial; padding: 20px; background: #fafafa;}
    h2 { text-align: center; }
    table { border-collapse: collapse; width: 90%; margin: 0 auto; }
    th, td { border: 1px solid #ddd; padding: 7px 12px; }
    th { background: #eee; }
    .bad { background: #ffeaea; color: #e40000;}
  </style>
</head>
<body>
<h2>Детальная разбаловка по каждому вопросу</h2>
<input type="file" id="fileInput" accept=".xlsx,.csv">
<div id="output"></div>
<script>
const weights = [8,7,6,7,5,8,7,6,5,6,5,8,7,6,7,5,4,5,5,4,7,5,6,5,7,8,7,6,7,6,8];
const likertMapping = {
  'Совсем не уверен': 1, 'Скорее не уверен': 2, 'Нейтрально': 3, 'Скорее уверен': 4, 'Полностью уверен': 5,
  'Демократический': 4, 'Директивный': 2, 'Ситуативный': 5, 'Либеральный': 3, 'Смешанный': 4,
  'Провожу дополнительное обсуждение, чтобы найти компромисс': 5,
  'Настаиваю на своём решении, так как уверен в его правильности': 2,
  'Пересматриваю решение с учётом мнения команды': 4,
  'Делегирую принятие решения команде': 3,
  'Игнорирую несогласие, так как считаю его необоснованным': 1,
  'Почти никогда': 1, 'Редко': 2, 'Иногда': 3, 'Часто': 4, 'Почти всегда': 5,
  'Легко адаптируюсь и нахожу баланс': 5,
  'Стараюсь разделять личную и профессиональную жизнь': 4,
  'Обращаюсь за поддержкой к коллегам или друзьям': 3,
  'Чувствую стресс, но продолжаю работать': 2,
  'Теряю продуктивность и не могу справиться с изменениями': 1,
  'Совсем не умею': 1, 'Редко удаётся': 2, 'Иногда удаётся': 3, 'Часто удаётся': 4, 'Почти всегда удаётся': 5,
  'Нет': 1, 'Да': 5,
  // Из твоих предыдущих подсказок:
  'Обращаюсь за советом к экспертам': 3,
  'Использую формальный подход, чтобы избежать конфликтов': 2,
  'Провожу индивидуальные беседы с участниками конфликта': 4,
  'Иногда удаётся достичь соглашения': 3,
  'Управлял(а) проектами средней сложности (3-12 месяцев)': 3,
  'Хорошо': 4,
  'Использую сложные системы планирования': 4,
  'Участвовал(а) в обсуждениях': 2,
  'Ускорю выполнение задач за счёт качества': 2,
  'Иногда проявляю креативность': 3,
  'Чувствую сильный стресс, но продолжаю работать': 2,
  'Часто удаётся адаптироваться': 4,
  'Управлял(а) средней командой (6-15 человек)': 3,
  'Intermediate (B1)': 3,
  'Использую для личных задач (например, ChatGPT)': 2,
  'Умею группировать задачи по проектам': 3,
  'Использую для совместной работы': 3,
  'Умею работать с простыми таблицами': 2,
  'Создаю простые сценарии автоматизации': 3,
};

document.getElementById('fileInput').addEventListener('change', function(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    let data = new Uint8Array(e.target.result);
    let workbook = XLSX.read(data, { type: 'array' });
    let sheet = workbook.Sheets[workbook.SheetNames[0]];
    let rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
    // ищем строку с ФИО
    let headerRow = rows.findIndex(row => row.some(c => (c+'').toLowerCase().includes('фам') || (c+'').toLowerCase().includes('фио')));
    if (headerRow < 0) {
      document.getElementById('output').innerHTML = "<b style='color:red'>Не найдена строка с ФИО/заголовками!</b>";
      return;
    }
    // Теперь перебор по респондентам
    let html = '';
    for(let i=headerRow+1; i<rows.length; ++i) {
      const row = rows[i];
      if (!row || !row[0]) continue; // пропуск пустых строк
      let fio = row[1] || row[0];
      html += `<h3>${fio}</h3><table><tr><th>Вопрос</th><th>Ответ</th><th>Балл</th></tr>`;
      for(let q=0; q<31; ++q) {
        let ans = row[q+3] ? (row[q+3]+'').trim() : '';
        let score = likertMapping[ans] ?? `<span class="bad">0 (нет разбаловки!)</span>`;
        html += `<tr${score.toString().includes('нет разбаловки') ? ' class="bad"' : ''}><td>Вопрос ${q+1}</td><td>${ans}</td><td>${score}</td></tr>`;
      }
      html += "</table><br>";
    }
    document.getElementById('output').innerHTML = html;
  };
  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
